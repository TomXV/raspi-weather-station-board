<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°—è±¡æƒ…å ±ãƒœãƒ¼ãƒ‰</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');

  :root {
    --bg: #0a0a0a;
    --panel: #111111;
    --border: #2a2a2a;
    --orange: #ff9900;
    --amber: #ffbb44;
    --white: #f0f0f0;
    --dim: #888888;
    --blue: #44aaff;
    --green: #44dd88;
    --red: #ff5544;
    --purple: #cc88ff;
    --marquee-alert-duration: 30s;
    --marquee-city-duration: 22s;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--white);
    font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif;
    min-height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  body.cursor-hidden,
  body.cursor-hidden * {
    cursor: none !important;
  }

  /* LED scanline effect */
  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 999;
  }

  .board {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 12px 14px;
    gap: 8px;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 2px solid var(--orange);
    padding-bottom: 10px;
  }

  .header-title {
    font-size: 1.35rem;
    font-weight: 900;
    color: var(--orange);
    letter-spacing: 0.18em;
    text-transform: uppercase;
    text-shadow: 0 0 12px rgba(255,153,0,0.7);
  }

  .header-clock {
    font-size: 2.8rem;
    font-weight: 900;
    color: var(--amber);
    letter-spacing: 0.05em;
    font-variant-numeric: tabular-nums;
    text-shadow: 0 0 16px rgba(255,187,68,0.8);
  }

  .header-date {
    font-size: 0.9rem;
    color: var(--dim);
    text-align: right;
  }

  .header-right {
    text-align: right;
  }

  .last-updated {
    font-size: 0.8rem;
    color: var(--dim);
    margin-top: 2px;
  }

  .info-row {
    display: flex;
    gap: 10px;
    align-items: stretch;
  }

  .info-box.alert-box {
    flex: 1 1 auto;
    min-width: 0;
  }

  .info-box.status-box {
    flex: 0 0 34%;
    min-width: 360px;
  }

  .info-box {
    background: #0f0f0f;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    min-height: 60px;
  }

  .info-title {
    font-size: 0.84rem;
    color: var(--dim);
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }

  .ticker {
    position: relative;
    overflow: hidden;
    white-space: nowrap;
    border-top: 1px solid rgba(255,255,255,0.08);
    margin-top: 2px;
    display: flex;
    align-items: center;
  }

  .ticker-track {
    display: inline-block;
    white-space: nowrap;
    padding-left: 0;
    font-family: 'Roboto Mono', 'Noto Sans JP', monospace;
    letter-spacing: 0.05em;
    font-weight: 700;
    animation: marquee var(--marquee-alert-duration) linear infinite;
    will-change: transform;
  }

  .alert-text {
    min-height: 4.1rem;
  }

  .alert-text .ticker-track {
    color: #ffd27a;
    font-size: 3.7rem;
    line-height: 1.08;
    text-shadow: 0 0 10px rgba(255,190,90,0.40);
  }

  .city-text .ticker-track {
    color: #9de3b1;
    font-size: 1.02rem;
    text-shadow: 0 0 8px rgba(110,240,160,0.30);
    animation-duration: var(--marquee-city-duration);
  }

  @keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  .status-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 4px 8px;
    font-size: 1rem;
    color: #dbe8f2;
  }

  .status-grid span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .status-grid span b {
    color: var(--amber);
    font-weight: 700;
  }

  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ™ãƒ« */
  .section-label {
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--orange);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border-left: 3px solid var(--orange);
    padding-left: 8px;
    margin-bottom: 6px;
    text-shadow: 0 0 8px rgba(255,153,0,0.5);
  }

  /* ä¸»è¦éƒ½å¸‚ã‚°ãƒªãƒƒãƒ‰ */
  .cities-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
  }

  /* é•·é‡ã‚°ãƒªãƒƒãƒ‰ */
  .nagano-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }

  /* å¤©æ°—ã‚«ãƒ¼ãƒ‰ */
  .weather-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
    height: 100%;
    justify-content: space-between;
  }

  .weather-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--orange), transparent);
    opacity: 0.5;
  }

  .nagano .weather-card::before {
    background: linear-gradient(90deg, var(--blue), transparent);
  }

  .card-city {
    font-size: 1.14rem;
    color: var(--white);
    letter-spacing: 0.01em;
    font-weight: 700;
  }

  .card-region {
    font-size: 0.84rem;
    color: var(--orange);
    letter-spacing: 0.01em;
  }

  .nagano .card-region {
    color: var(--blue);
  }

  .card-weather-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-icon {
    font-size: 2.55rem;
    line-height: 1;
  }

  .card-temp {
    font-size: 3.2rem;
    font-weight: 900;
    color: var(--amber);
    font-variant-numeric: tabular-nums;
    text-shadow: 0 0 12px rgba(255,187,68,0.5);
    line-height: 1;
  }

  .card-temp-unit {
    font-size: 1.25rem;
    color: var(--dim);
    font-weight: 400;
  }

  .card-desc {
    font-size: 0.96rem;
    color: var(--white);
    letter-spacing: 0.01em;
  }

  .card-details {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .card-detail {
    font-size: 0.86rem;
    color: var(--dim);
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .card-minmax {
    font-size: 0.94rem;
    color: var(--dim);
    font-variant-numeric: tabular-nums;
  }

  .card-minmax .max { color: #ff7755; }
  .card-minmax .min { color: #55aaff; }

  .card-precip {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 3px;
    background: rgba(68,170,255,0.15);
    color: var(--blue);
    border: 1px solid rgba(68,170,255,0.3);
  }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
  .loading {
    color: var(--dim);
    font-size: 0.8rem;
    animation: blink 1s ease infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* ã‚¨ãƒ©ãƒ¼ */
  .error { color: var(--red); font-size: 0.7rem; }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--border);
    padding-top: 8px;
    font-size: 0.6rem;
    color: var(--dim);
  }

  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 2px 0;
  }

  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .weather-card.loaded {
    animation: fadeIn 0.4s ease;
  }
</style>
</head>
<body>
<div class="board">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-title">â›… æ°—è±¡æƒ…å ±ãƒœãƒ¼ãƒ‰</div>
    <div class="header-right">
      <div class="header-clock" id="clock">--:--:--</div>
      <div class="header-date" id="date-str">----/--/--</div>
      <div class="last-updated" id="last-updated">æ›´æ–°ä¸­...</div>
    </div>
  </div>

  <div class="info-row">
    <div class="info-box alert-box">
      <div class="info-title">âš  è­¦å ±ãƒ»æ³¨æ„å ±ï¼ˆä¸»è¦éƒ½å¸‚ + é•·é‡çœŒ / ç”Ÿæ–‡ï¼‰</div>
      <div class="ticker alert-text"><span class="ticker-track" id="alert-track">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <!-- ä¸»è¦éƒ½å¸‚é€Ÿå ±ãƒ†ãƒ­ãƒƒãƒ—ã¯éè¡¨ç¤ºï¼ˆä¸‹æ®µã‚«ãƒ¼ãƒ‰ã§ååˆ†ãªãŸã‚ï¼‰ -->
    </div>
    <div class="info-box status-box" style="border-color:rgba(68,170,255,0.45);box-shadow:inset 0 0 0 1px rgba(68,170,255,0.08)">
      <div class="info-title">ğŸ–¥ Raspberry Pi ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
      <div class="status-grid" id="pi-status">
        <span>æ¸©åº¦: <b>--</b></span>
        <span>è² è·: <b>--</b></span>
        <span>ãƒ¡ãƒ¢ãƒª: <b>--</b></span>
        <span>ãƒ‡ã‚£ã‚¹ã‚¯: <b>--</b></span>
        <span>ç¨¼åƒ: <b>--</b></span>
        <span>IP: <b>--</b></span>
      </div>
    </div>
  </div>

  <!-- ä¸»è¦éƒ½å¸‚ -->
  <div style="flex:1;display:flex;flex-direction:column;">
    <div class="section-label">â–¶ ä¸»è¦éƒ½å¸‚</div>
    <div class="cities-grid" id="cities-grid" style="flex:1;align-content:stretch;">
      <!-- JS ã§ç”Ÿæˆ -->
    </div>
  </div>

  <hr class="divider">

  <!-- é•·é‡çœŒ -->
  <div class="nagano" style="flex:1;display:flex;flex-direction:column;">
    <div class="section-label" style="color:var(--blue);border-color:var(--blue);text-shadow:0 0 8px rgba(68,170,255,0.5)">â–¶ é•·é‡çœŒ <span id="nagano-page-indicator" style="font-size:0.8em;color:#8ecbff;letter-spacing:0.03em;">(1/2)</span></div>
    <div class="nagano-grid" id="nagano-grid" style="flex:1;align-content:stretch;">
      <!-- JS ã§ç”Ÿæˆ -->
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <div class="footer">
    <span>Data: Open-Meteo.com (CC BY 4.0)</span>
    <span>30åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–° â€” Raspberry Pi 5</span>
  </div>
</div>

<script>
const CITIES = [
  { id: 'sapporo', name: 'æœ­å¹Œ',    region: 'åŒ—æµ·é“',  lat: 43.0618, lon: 141.3545 },
  { id: 'sendai',  name: 'ä»™å°',    region: 'å®®åŸçœŒ',  lat: 38.2688, lon: 140.8721 },
  { id: 'tokyo',   name: 'æ±äº¬',    region: 'æ±äº¬éƒ½',  lat: 35.6762, lon: 139.6503 },
  { id: 'nagoya',  name: 'åå¤å±‹',  region: 'æ„›çŸ¥çœŒ',  lat: 35.1815, lon: 136.9066 },
  { id: 'osaka',   name: 'å¤§é˜ª',    region: 'å¤§é˜ªåºœ',  lat: 34.6937, lon: 135.5023 },
  { id: 'fukuoka', name: 'ç¦å²¡',    region: 'ç¦å²¡çœŒ',  lat: 33.5904, lon: 130.4017 },
];

const NAGANO = [
  { id: 'hokushin',   name: 'é•·é‡å¸‚', region: 'åŒ—ä¿¡', lat: 36.6485, lon: 138.1948 },
  { id: 'toushin',    name: 'ä¸Šç”°å¸‚', region: 'æ±ä¿¡', lat: 36.4020, lon: 138.2490 },
  { id: 'chushin',    name: 'æ¾æœ¬å¸‚', region: 'ä¸­ä¿¡', lat: 36.2380, lon: 137.9724 },
  { id: 'nanshin',    name: 'é£¯ç”°å¸‚', region: 'å—ä¿¡', lat: 35.5151, lon: 137.8217 },
  { id: 'suwa',       name: 'è«è¨ªå¸‚', region: 'è«è¨ªã‚¨ãƒªã‚¢', lat: 36.0392, lon: 138.1131 },
  { id: 'inaji',      name: 'ä¼Šé‚£å¸‚', region: 'ä¼Šé‚£è·¯ã‚¨ãƒªã‚¢', lat: 35.8274, lon: 137.9537 },
  { id: 'kisoj',      name: 'æœ¨æ›½ç”º', region: 'æœ¨æ›½è·¯ã‚¨ãƒªã‚¢', lat: 35.8423, lon: 137.6937 },
  { id: 'alps',       name: 'å¤§ç”ºå¸‚', region: 'æ—¥æœ¬ã‚¢ãƒ«ãƒ—ã‚¹ã‚¨ãƒªã‚¢', lat: 36.5045, lon: 137.8518 },
];

const WARNING_AREAS = [
  { label: 'æœ­å¹Œ(åŒ—æµ·é“)', code: '016000' },
  { label: 'ä»™å°(å®®åŸçœŒ)', code: '040000' },
  { label: 'æ±äº¬(æ±äº¬éƒ½)', code: '130000' },
  { label: 'åå¤å±‹(æ„›çŸ¥çœŒ)', code: '230000' },
  { label: 'å¤§é˜ª(å¤§é˜ªåºœ)', code: '270000' },
  { label: 'ç¦å²¡(ç¦å²¡çœŒ)', code: '400000' },
  { label: 'é•·é‡çœŒ', code: '200000' },
];

// WMO å¤©æ°—ã‚³ãƒ¼ãƒ‰ â†’ çµµæ–‡å­— + æ—¥æœ¬èª
function decodeWMO(code) {
  const map = {
    0:  { icon: 'â˜€ï¸',  desc: 'å¿«æ™´' },
    1:  { icon: 'ğŸŒ¤ï¸', desc: 'ã»ã¼æ™´ã‚Œ' },
    2:  { icon: 'â›…',  desc: 'ä¸€éƒ¨æ›‡ã‚Š' },
    3:  { icon: 'â˜ï¸',  desc: 'æ›‡ã‚Š' },
    45: { icon: 'ğŸŒ«ï¸', desc: 'éœ§' },
    48: { icon: 'ğŸŒ«ï¸', desc: 'éœ§(ç€æ°·)' },
    51: { icon: 'ğŸŒ¦ï¸', desc: 'éœ§é›¨(å¼±)' },
    53: { icon: 'ğŸŒ¦ï¸', desc: 'éœ§é›¨' },
    55: { icon: 'ğŸŒ¦ï¸', desc: 'éœ§é›¨(å¼·)' },
    61: { icon: 'ğŸŒ§ï¸', desc: 'é›¨(å¼±)' },
    63: { icon: 'ğŸŒ§ï¸', desc: 'é›¨' },
    65: { icon: 'ğŸŒ§ï¸', desc: 'é›¨(å¼·)' },
    71: { icon: 'ğŸŒ¨ï¸', desc: 'é›ª(å¼±)' },
    73: { icon: 'â„ï¸',  desc: 'é›ª' },
    75: { icon: 'â„ï¸',  desc: 'é›ª(å¼·)' },
    77: { icon: 'ğŸŒ¨ï¸', desc: 'ã‚ã‚‰ã‚Œ' },
    80: { icon: 'ğŸŒ¦ï¸', desc: 'ã«ã‚ã‹é›¨(å¼±)' },
    81: { icon: 'ğŸŒ¦ï¸', desc: 'ã«ã‚ã‹é›¨' },
    82: { icon: 'â›ˆï¸', desc: 'ã«ã‚ã‹é›¨(å¼·)' },
    85: { icon: 'ğŸŒ¨ï¸', desc: 'ã«ã‚ã‹é›ª' },
    86: { icon: 'ğŸŒ¨ï¸', desc: 'ã«ã‚ã‹é›ª(å¼·)' },
    95: { icon: 'â›ˆï¸', desc: 'é›·é›¨' },
    96: { icon: 'â›ˆï¸', desc: 'é›·é›¨+ã²ã‚‡ã†' },
    99: { icon: 'â›ˆï¸', desc: 'æ¿€ã—ã„é›·é›¨' },
  };
  return map[code] || { icon: 'â“', desc: `(${code})` };
}

// ã‚«ãƒ¼ãƒ‰ HTML ç”Ÿæˆ
function buildCard(loc, isNagano) {
  const card = document.createElement('div');
  card.className = 'weather-card';
  card.id = `card-${loc.id}`;
  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="card-city">${loc.name}</div>
        <div class="card-region">${loc.region}</div>
      </div>
      <div class="loading">â€¦</div>
    </div>
  `;
  return card;
}

const NAGANO_PAGE_SIZE = 4;
let naganoPage = 0;
const weatherCache = {};

function renderNaganoPage(pageIndex) {
  const ng = document.getElementById('nagano-grid');
  if (!ng) return;

  const pageCount = Math.ceil(NAGANO.length / NAGANO_PAGE_SIZE);
  naganoPage = ((pageIndex % pageCount) + pageCount) % pageCount;

  const start = naganoPage * NAGANO_PAGE_SIZE;
  const rows = NAGANO.slice(start, start + NAGANO_PAGE_SIZE);

  ng.innerHTML = '';
  rows.forEach(c => {
    ng.appendChild(buildCard(c, true));
    if (weatherCache[c.id]) updateCard(c, weatherCache[c.id]);
  });

  const ind = document.getElementById('nagano-page-indicator');
  if (ind) ind.textContent = `(${naganoPage + 1}/${pageCount})`;
}

// ã‚°ãƒªãƒƒãƒ‰ã«ã‚«ãƒ¼ãƒ‰é…ç½®
function initGrids() {
  const cg = document.getElementById('cities-grid');
  CITIES.forEach(c => cg.appendChild(buildCard(c, false)));

  renderNaganoPage(0);
}

// Open-Meteo API ã‹ã‚‰å–å¾—
async function fetchWeather(loc) {
  const url = `https://api.open-meteo.com/v1/forecast?`
    + `latitude=${loc.lat}&longitude=${loc.lon}`
    + `&current=temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m`
    + `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max`
    + `&timezone=Asia%2FTokyo&forecast_days=1`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(res.status);
  return res.json();
}

function setTickerText(trackId, text) {
  const el = document.getElementById(trackId);
  if (!el) return;
  const clean = (text || '').trim() || 'æƒ…å ±ãªã—';
  // ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã«åŒã˜å†…å®¹ã‚’2å›ä¸¦ã¹ã‚‹
  el.textContent = `${clean}ã€€â—†ã€€${clean}ã€€â—†ã€€`;

  // é•·æ–‡ã»ã©ã‚†ã£ãã‚Šæµã™ï¼ˆå¯èª­æ€§å„ªå…ˆï¼‰
  const sec = Math.max(24, Math.min(90, Math.round(clean.length * 0.45)));
  el.style.animationDuration = `${sec}s`;
}

function updateCityTicker() {
  const chunks = CITIES.map(c => {
    const data = weatherCache[c.id];
    if (!data || !data.current || !data.daily) return `${c.name}: --`;
    const { desc } = decodeWMO(data.current.weather_code);
    const t = Math.round(data.current.temperature_2m);
    const rain = data.daily.precipitation_probability_max?.[0] ?? '--';
    return `${c.name} ${t}Â°C ${desc} é™æ°´${rain}%`;
  });
  setTickerText('city-track', chunks.join(' ï½œ '));
}

async function fetchWarningInfo() {
  try {
    const results = await Promise.allSettled(
      WARNING_AREAS.map(async area => {
        const res = await fetch(`https://www.jma.go.jp/bosai/warning/data/warning/${area.code}.json`);
        if (!res.ok) throw new Error(String(res.status));
        const data = await res.json();
        const headline = (data.headlineText || '').trim();
        const reportTime = (data.reportDatetime || '').replace('T', ' ').replace('+09:00', '');
        if (!headline) return `${area.label}: ç¾åœ¨ã€ç›®ç«‹ã¤è­¦å ±è¦‹å‡ºã—ãªã—`;
        return `${area.label} [${reportTime}] ${headline}`;
      })
    );

    const lines = results.map((r, i) => {
      if (r.status === 'fulfilled') return r.value;
      return `${WARNING_AREAS[i].label}: å–å¾—å¤±æ•—`;
    });

    setTickerText('alert-track', lines.join(' ï½œ '));
  } catch (e) {
    setTickerText('alert-track', 'è­¦å ±ãƒ»æ³¨æ„å ±æƒ…å ±ã®å–å¾—ã«å¤±æ•—');
  }
}

async function fetchPiStatus() {
  try {
    const res = await fetch('/api/pi-status');
    if (!res.ok) throw new Error('status');
    const s = await res.json();
    const mem = s.mem ? `${s.mem.used_gb}/${s.mem.total_gb}GB (${s.mem.used_pct}%)` : '--';
    const disk = s.disk ? `${s.disk.used_gb}/${s.disk.total_gb}GB (${s.disk.used_pct}%)` : '--';
    const temp = (s.cpu_temp_c ?? '--');
    const load = (s.load1 ?? '--');
    const uptime = s.uptime || '--';
    const ip = s.ip || '--';

    document.getElementById('pi-status').innerHTML = `
      <span>æ¸©åº¦: <b>${temp}Â°C</b></span>
      <span>è² è·: <b>${load}</b></span>
      <span>ãƒ¡ãƒ¢ãƒª: <b>${mem}</b></span>
      <span>ãƒ‡ã‚£ã‚¹ã‚¯: <b>${disk}</b></span>
      <span>ç¨¼åƒ: <b>${uptime}</b></span>
      <span>IP: <b>${ip}</b></span>
    `;
  } catch (e) {
    document.getElementById('pi-status').innerHTML = `<span>å–å¾—å¤±æ•—</span>`;
  }
}

// ã‚«ãƒ¼ãƒ‰æ›´æ–°
function updateCard(loc, data) {
  const card = document.getElementById(`card-${loc.id}`);
  if (!card) return;

  const cur = data.current;
  const daily = data.daily;
  const { icon, desc } = decodeWMO(cur.weather_code);
  const tempMax = Math.round(daily.temperature_2m_max[0]);
  const tempMin = Math.round(daily.temperature_2m_min[0]);
  const precip = daily.precipitation_probability_max[0] ?? '--';

  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="card-city">${loc.name}</div>
        <div class="card-region">${loc.region}</div>
      </div>
      <div class="card-precip">ğŸ’§${precip}%</div>
    </div>
    <div class="card-weather-row">
      <span class="card-icon">${icon}</span>
      <div>
        <div>
          <span class="card-temp">${Math.round(cur.temperature_2m)}</span>
          <span class="card-temp-unit">Â°C</span>
        </div>
        <div class="card-desc">${desc}</div>
      </div>
    </div>
    <div class="card-minmax">
      <span class="max">â†‘${tempMax}Â°</span>
      &nbsp;
      <span class="min">â†“${tempMin}Â°</span>
    </div>
    <div class="card-details">
      <span class="card-detail">ğŸ’¨ ${Math.round(cur.wind_speed_10m)}km/h</span>
      <span class="card-detail">ğŸ’§ ${cur.relative_humidity_2m}%</span>
    </div>
  `;
  card.classList.add('loaded');
}

function setCardError(loc, msg) {
  const card = document.getElementById(`card-${loc.id}`);
  if (!card) return;
  card.innerHTML = `
    <div class="card-city">${loc.name}</div>
    <div class="card-region">${loc.region}</div>
    <div class="error">å–å¾—å¤±æ•—</div>
  `;
}

// å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°
async function refresh() {
  document.getElementById('last-updated').textContent = 'æ›´æ–°ä¸­...';
  const all = [...CITIES, ...NAGANO];
  await Promise.allSettled(all.map(async loc => {
    try {
      const data = await fetchWeather(loc);
      weatherCache[loc.id] = data;
      updateCard(loc, data);
    } catch (e) {
      setCardError(loc, e.message);
    }
  }));
  updateCityTicker();
  const now = new Date();
  document.getElementById('last-updated').textContent =
    `æœ€çµ‚æ›´æ–°: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}

// æ™‚è¨ˆ
function tickClock() {
  const now = new Date();
  const h = now.getHours().toString().padStart(2,'0');
  const m = now.getMinutes().toString().padStart(2,'0');
  const s = now.getSeconds().toString().padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;

  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const y = now.getFullYear();
  const mo = (now.getMonth()+1).toString().padStart(2,'0');
  const d = now.getDate().toString().padStart(2,'0');
  const dow = days[now.getDay()];
  document.getElementById('date-str').textContent = `${y}/${mo}/${d} (${dow})`;
}

// ã‚«ãƒ¼ã‚½ãƒ«è‡ªå‹•éè¡¨ç¤ºï¼ˆèµ·å‹•ç›´å¾Œã‹ã‚‰éè¡¨ç¤º / 3ç§’ç„¡æ“ä½œã§å†ã³éš ã™ï¼‰
let cursorHideTimer;
function showCursorTemporarily() {
  document.body.classList.remove('cursor-hidden');
  clearTimeout(cursorHideTimer);
  cursorHideTimer = setTimeout(() => {
    document.body.classList.add('cursor-hidden');
  }, 3000);
}
['mousemove','mousedown','wheel','touchstart','keydown'].forEach(evt => {
  window.addEventListener(evt, showCursorTemporarily, { passive: true });
});

// åˆæœŸåŒ–
initGrids();
tickClock();
setInterval(tickClock, 1000);

refresh();
fetchWarningInfo();
fetchPiStatus();
document.body.classList.add('cursor-hidden');

setInterval(refresh, 30 * 60 * 1000); // 30åˆ†ã”ã¨
setInterval(fetchWarningInfo, 10 * 60 * 1000); // 10åˆ†ã”ã¨
setInterval(fetchPiStatus, 60 * 1000); // 1åˆ†ã”ã¨
setInterval(() => renderNaganoPage(naganoPage + 1), 12 * 1000); // 12ç§’ã”ã¨ã«é•·é‡ãƒšãƒ¼ã‚¸åˆ‡æ›¿
</script>
</body>
</html>
