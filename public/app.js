var H=[{id:"sapporo",name:"札幌",enName:"Sapporo",zhName:"札幌",koName:"삿포로",region:"北海道",enRegion:"Hokkaido",zhRegion:"北海道",koRegion:"홋카이도",lat:43.0618,lon:141.3545},{id:"sendai",name:"仙台",enName:"Sendai",zhName:"仙台",koName:"센다이",region:"宮城県",enRegion:"Miyagi",zhRegion:"宫城县",koRegion:"미야기현",lat:38.2688,lon:140.8721},{id:"tokyo",name:"東京",enName:"Tokyo",zhName:"东京",koName:"도쿄",region:"東京都",enRegion:"Tokyo",zhRegion:"东京都",koRegion:"도쿄도",lat:35.6762,lon:139.6503},{id:"nagoya",name:"名古屋",enName:"Nagoya",zhName:"名古屋",koName:"나고야",region:"愛知県",enRegion:"Aichi",zhRegion:"爱知县",koRegion:"아이치현",lat:35.1815,lon:136.9066},{id:"osaka",name:"大阪",enName:"Osaka",zhName:"大阪",koName:"오사카",region:"大阪府",enRegion:"Osaka",zhRegion:"大阪府",koRegion:"오사카부",lat:34.6937,lon:135.5023},{id:"fukuoka",name:"福岡",enName:"Fukuoka",zhName:"福冈",koName:"후쿠오카",region:"福岡県",enRegion:"Fukuoka",zhRegion:"福冈县",koRegion:"후쿠오카현",lat:33.5904,lon:130.4017}],y=[{id:"hokushin",name:"長野市",enName:"Nagano",zhName:"长野市",koName:"나가노시",region:"北信",enRegion:"North Shin",zhRegion:"北信",koRegion:"북신",lat:36.6485,lon:138.1948},{id:"toushin",name:"上田市",enName:"Ueda",zhName:"上田市",koName:"우에다시",region:"東信",enRegion:"East Shin",zhRegion:"东信",koRegion:"동신",lat:36.402,lon:138.249},{id:"chushin",name:"松本市",enName:"Matsumoto",zhName:"松本市",koName:"마쓰모토시",region:"中信",enRegion:"Central Shin",zhRegion:"中信",koRegion:"중신",lat:36.238,lon:137.9724},{id:"nanshin",name:"飯田市",enName:"Iida",zhName:"饭田市",koName:"이다시",region:"南信",enRegion:"South Shin",zhRegion:"南信",koRegion:"남신",lat:35.5151,lon:137.8217},{id:"suwa",name:"諏訪市",enName:"Suwa",zhName:"诹访市",koName:"스와시",region:"諏訪エリア",enRegion:"Suwa Area",zhRegion:"诹访区域",koRegion:"스와 지역",lat:36.0392,lon:138.1131},{id:"inaji",name:"伊那市",enName:"Ina",zhName:"伊那市",koName:"이나시",region:"伊那路エリア",enRegion:"Inaji Area",zhRegion:"伊那路区域",koRegion:"이나지 지역",lat:35.8274,lon:137.9537},{id:"kisoj",name:"木曽町",enName:"Kiso",zhName:"木曾町",koName:"기소마치",region:"木曽路エリア",enRegion:"Kisoji Area",zhRegion:"木曾路区域",koRegion:"기소지 지역",lat:35.8423,lon:137.6937},{id:"alps",name:"大町市",enName:"Omachi",zhName:"大町市",koName:"오마치시",region:"日本アルプスエリア",enRegion:"Japan Alps Area",zhRegion:"日本阿尔卑斯区域",koRegion:"일본 알프스 지역",lat:36.5045,lon:137.8518}],_=[{code:"016000",labelJa:"札幌(北海道)",labelEn:"Sapporo (Hokkaido)",labelZh:"札幌（北海道）"},{code:"040000",labelJa:"仙台(宮城県)",labelEn:"Sendai (Miyagi)",labelZh:"仙台（宫城县）"},{code:"130000",labelJa:"東京(東京都)",labelEn:"Tokyo (Tokyo)",labelZh:"东京（东京都）"},{code:"230000",labelJa:"名古屋(愛知県)",labelEn:"Nagoya (Aichi)",labelZh:"名古屋（爱知县）"},{code:"270000",labelJa:"大阪(大阪府)",labelEn:"Osaka (Osaka)",labelZh:"大阪（大阪府）"},{code:"400000",labelJa:"福岡(福岡県)",labelEn:"Fukuoka (Fukuoka)",labelZh:"福冈（福冈县）"},{code:"200000",labelJa:"長野県",labelEn:"Nagano",labelZh:"长野县"}],K="ja",v={ja:{boardTitle:"⛅ 気象情報ボード",warningTitle:"⚠ 警報・注意報（主要都市 + 長野県 / 生文）",piTitle:"\uD83D\uDDA5 Raspberry Pi ステータス",majorLabel:"▶ 主要都市",naganoLabel:"▶ 長野県",updated:"最終更新",updating:"更新中...",precip:"降水量",wind:"風速",humidity:"湿度",failed:"取得失敗",page:"ページ",nextUpdate:"次回更新まで",calGregorian:"西暦",calJapanese:"和暦",calChinese:"中国暦"},en:{boardTitle:"⛅ Weather Board",warningTitle:"⚠ Warning / Advisory (Major Cities + Nagano / Raw Text)",piTitle:"\uD83D\uDDA5 Raspberry Pi Status",majorLabel:"▶ Major Cities",naganoLabel:"▶ Nagano",updated:"Updated",updating:"Updating...",precip:"Rain",wind:"Wind",humidity:"Humidity",failed:"Fetch Failed",page:"Page",nextUpdate:"Next update in",calGregorian:"Gregorian",calJapanese:"Japanese Era",calChinese:"Chinese Calendar"},zh:{boardTitle:"⛅ 气象信息看板",warningTitle:"⚠ 警报/注意报（主要城市 + 长野 / 原文）",piTitle:"\uD83D\uDDA5 Raspberry Pi 状态",majorLabel:"▶ 主要城市",naganoLabel:"▶ 长野",updated:"更新",updating:"更新中...",precip:"降水",wind:"风速",humidity:"湿度",failed:"获取失败",page:"页",nextUpdate:"距离下次更新",calGregorian:"公历",calJapanese:"和历",calChinese:"农历"},ko:{boardTitle:"⛅ 기상 정보 보드",warningTitle:"⚠ 경보/주의보 (주요 도시 + 나가노 / 원문)",piTitle:"\uD83D\uDDA5 Raspberry Pi 상태",majorLabel:"▶ 주요 도시",naganoLabel:"▶ 나가노",updated:"갱신",updating:"갱신 중...",precip:"강수",wind:"풍속",humidity:"습도",failed:"가져오기 실패",page:"페이지",nextUpdate:"다음 업데이트까지",calGregorian:"서기",calJapanese:"화력",calChinese:"중국력"}};function T(q){return{0:{icon:"☀️",ja:"快晴",en:"Clear",ko:"맑음"},1:{icon:"\uD83C\uDF24️",ja:"ほぼ晴れ",en:"Mostly clear",ko:"대체로 맑음"},2:{icon:"⛅",ja:"一部曇り",en:"Partly cloudy",ko:"부분적으로 흐림"},3:{icon:"☁️",ja:"曇り",en:"Cloudy",ko:"흐림"},45:{icon:"\uD83C\uDF2B️",ja:"霧",en:"Fog",ko:"안개"},48:{icon:"\uD83C\uDF2B️",ja:"霧(着氷)",en:"Rime fog",ko:"착빙 안개"},51:{icon:"\uD83C\uDF26️",ja:"霧雨(弱)",en:"Light drizzle",ko:"약한 이슬비"},53:{icon:"\uD83C\uDF26️",ja:"霧雨",en:"Drizzle",ko:"이슬비"},55:{icon:"\uD83C\uDF26️",ja:"霧雨(強)",en:"Dense drizzle",ko:"강한 이슬비"},61:{icon:"\uD83C\uDF27️",ja:"雨(弱)",en:"Light rain",ko:"약한 비"},63:{icon:"\uD83C\uDF27️",ja:"雨",en:"Rain",ko:"비"},65:{icon:"\uD83C\uDF27️",ja:"雨(強)",en:"Heavy rain",ko:"강한 비"},71:{icon:"\uD83C\uDF28️",ja:"雪(弱)",en:"Light snow",ko:"약한 눈"},73:{icon:"❄️",ja:"雪",en:"Snow",ko:"눈"},75:{icon:"❄️",ja:"雪(強)",en:"Heavy snow",ko:"강한 눈"},77:{icon:"\uD83C\uDF28️",ja:"あられ",en:"Snow grains",ko:"싸락눈"},80:{icon:"\uD83C\uDF26️",ja:"にわか雨(弱)",en:"Light showers",ko:"약한 소나기"},81:{icon:"\uD83C\uDF26️",ja:"にわか雨",en:"Showers",ko:"소나기"},82:{icon:"⛈️",ja:"にわか雨(強)",en:"Heavy showers",ko:"강한 소나기"},85:{icon:"\uD83C\uDF28️",ja:"にわか雪",en:"Snow showers",ko:"눈 소나기"},86:{icon:"\uD83C\uDF28️",ja:"にわか雪(強)",en:"Heavy snow showers",ko:"강한 눈 소나기"},95:{icon:"⛈️",ja:"雷雨",en:"Thunderstorm",ko:"뇌우"},96:{icon:"⛈️",ja:"雷雨+ひょう",en:"Storm + hail",ko:"뇌우+우박"},99:{icon:"⛈️",ja:"激しい雷雨",en:"Severe storm",ko:"강한 뇌우"}}[q]||{icon:"❓",ja:`(${q})`,en:`(${q})`,ko:`(${q})`}}function P(q){let z=K==="en"?q.enName||q.name:K==="zh"?q.zhName||q.enName||q.name:K==="ko"?q.koName||q.enName||q.name:q.name,B=K==="en"?q.enRegion||q.region:K==="zh"?q.zhRegion||q.enRegion||q.region:K==="ko"?q.koRegion||q.enRegion||q.region:q.region;return{name:z,region:B}}function p(){let q=v[K],z=document.getElementById("board-title");if(z)z.textContent=q.boardTitle;let B=document.getElementById("warning-title");if(B)B.textContent=q.warningTitle;let J=document.getElementById("pi-title");if(J)J.textContent=q.piTitle;let V=document.getElementById("major-label");if(V)V.textContent=q.majorLabel;let Q=document.getElementById("nagano-label");if(Q)Q.textContent=q.naganoLabel;i(new Date)}function m(q){return q.labelJa}function h(q,z){let B=document.createElement("div");B.className="weather-card",B.id=`card-${q.id}`;let J=P(q);return B.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="card-city">${J.name}</div>
        <div class="card-region">${J.region}</div>
      </div>
      <div class="loading">…</div>
    </div>
  `,B}var U=4,f=1800000,E=Date.now()+f,Z=0,F={};function b(q){let z=document.getElementById("nagano-grid");if(!z)return;let B=Math.ceil(y.length/U);Z=(q%B+B)%B;let J=Z*U,V=y.slice(J,J+U);z.innerHTML="",V.forEach((Y)=>{if(z.appendChild(h(Y,!0)),F[Y.id])R(Y,F[Y.id])});let Q=document.getElementById("nagano-page-indicator");if(Q)Q.textContent=`(${Z+1}/${B})`}function g(){let q=document.getElementById("cities-grid");H.forEach((z)=>q.appendChild(h(z,!1))),b(0)}async function d(q){let z=`https://api.open-meteo.com/v1/forecast?latitude=${q.lat}&longitude=${q.lon}&current=temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=1`,B=await fetch(z);if(!B.ok)throw Error(B.status);return B.json()}function G(q,z){let B=document.getElementById(q);if(!B)return;let J=(z||"").trim()||"情報なし";B.textContent=`${J}　◆　${J}　◆　`;let V=Math.max(24,Math.min(90,Math.round(J.length*0.45)));B.style.animationDuration=`${V}s`}function l(){let q=H.map((z)=>{let B=F[z.id];if(!B||!B.current||!B.daily)return`${z.name}: --`;let{desc:J}=T(B.current.weather_code),V=Math.round(B.current.temperature_2m),Q=B.daily.precipitation_probability_max?.[0]??"--";return`${z.name} ${V}°C ${J} 降水${Q}%`});G("city-track",q.join(" ｜ "))}async function k(){try{let z=(await Promise.allSettled(_.map(async(B)=>{let J=await fetch(`https://www.jma.go.jp/bosai/warning/data/warning/${B.code}.json`);if(!J.ok)throw Error(String(J.status));let V=await J.json(),Q=(V.headlineText||"").trim(),Y=(V.reportDatetime||"").replace("T"," ").replace("+09:00",""),j=m(B);if(!Q)return`${j}: 現在、目立つ警報見出しなし`;return`${j} [${Y}] ${Q}`}))).map((B,J)=>{if(B.status==="fulfilled")return B.value;return`${m(_[J])}: 取得失敗`});G("alert-track",z.join(" ｜ "))}catch(q){G("alert-track","警報・注意報情報の取得に失敗")}}async function x(){try{let q=await fetch("/api/pi-status");if(!q.ok)throw Error("status");let z=await q.json(),B=z.mem?`${z.mem.used_gb}/${z.mem.total_gb}GB (${z.mem.used_pct}%)`:"--",J=z.disk?`${z.disk.used_gb}/${z.disk.total_gb}GB (${z.disk.used_pct}%)`:"--",V=z.cpu_temp_c??"--",Q=z.load1??"--",Y=z.uptime||"--",j=z.ip||"--",$=K==="en"?{temp:"Temp",load:"Load",mem:"Memory",disk:"Disk",up:"Uptime",ip:"IP"}:K==="zh"?{temp:"温度",load:"负载",mem:"内存",disk:"磁盘",up:"运行时长",ip:"IP"}:K==="ko"?{temp:"온도",load:"부하",mem:"메모리",disk:"디스크",up:"가동시간",ip:"IP"}:{temp:"温度",load:"負荷",mem:"メモリ",disk:"ディスク",up:"稼働",ip:"IP"};document.getElementById("pi-status").innerHTML=`
      <span>${$.temp}: <b>${V}°C</b></span>
      <span>${$.load}: <b>${Q}</b></span>
      <span>${$.mem}: <b>${B}</b></span>
      <span>${$.disk}: <b>${J}</b></span>
      <span>${$.up}: <b>${Y}</b></span>
      <span>${$.ip}: <b>${j}</b></span>
    `}catch(q){document.getElementById("pi-status").innerHTML=`<span>${v[K].failed}</span>`}}function R(q,z){let B=document.getElementById(`card-${q.id}`);if(!B)return;let{current:J,daily:V}=z,Q=T(J.weather_code),Y=K==="en"?Q.en:K==="zh"?Q.zh||Q.en:K==="ko"?Q.ko||Q.en:Q.ja,j=Math.round(V.temperature_2m_max[0]),$=Math.round(V.temperature_2m_min[0]),M=V.precipitation_probability_max[0]??"--",X=P(q),D=v[K];B.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="card-city">${X.name}</div>
        <div class="card-region">${X.region}</div>
      </div>
      <div class="card-precip">${D.precip}:${M}%</div>
    </div>
    <div class="card-weather-row">
      <span class="card-icon">${Q.icon}</span>
      <div>
        <div>
          <span class="card-temp">${Math.round(J.temperature_2m)}</span>
          <span class="card-temp-unit">°C</span>
        </div>
        <div class="card-desc">${Y}</div>
      </div>
    </div>
    <div class="card-minmax">
      <span class="max">↑${j}°</span>
      &nbsp;
      <span class="min">↓${$}°</span>
    </div>
    <div class="card-details">
      <span class="card-detail">\uD83D\uDCA8 ${D.wind} ${Math.round(J.wind_speed_10m)}km/h</span>
      <span class="card-detail">\uD83D\uDCA7 ${D.humidity} ${J.relative_humidity_2m}%</span>
    </div>
  `,B.classList.add("loaded")}function t(q,z){let B=document.getElementById(`card-${q.id}`);if(!B)return;let J=P(q);B.innerHTML=`
    <div class="card-city">${J.name}</div>
    <div class="card-region">${J.region}</div>
    <div class="error">${v[K].failed}</div>
  `}async function L(){document.getElementById("last-updated").textContent=`${v[K].updating}`;let q=[...H,...y];await Promise.allSettled(q.map(async(B)=>{try{let J=await d(B);F[B.id]=J,R(B,J)}catch(J){t(B,J.message)}})),l();let z=new Date;E=z.getTime()+f,document.getElementById("last-updated").textContent=`${v[K].updated}: ${z.getHours().toString().padStart(2,"0")}:${z.getMinutes().toString().padStart(2,"0")}`}function o(q,z){try{if(z==="gregory")return`${q.getFullYear()}/${String(q.getMonth()+1).padStart(2,"0")}/${String(q.getDate()).padStart(2,"0")}`;if(z==="japanese")return new Intl.DateTimeFormat("ja-JP-u-ca-japanese",{year:"numeric",month:"2-digit",day:"2-digit"}).format(q);return new Intl.DateTimeFormat("zh-CN-u-ca-chinese",{year:"numeric",month:"long",day:"numeric"}).format(q)}catch{return`${q.getFullYear()}/${String(q.getMonth()+1).padStart(2,"0")}/${String(q.getDate()).padStart(2,"0")}`}}function i(q){let z=Math.max(0,E-q.getTime()),B=String(Math.floor(z/60000)).padStart(2,"0"),J=String(Math.floor(z%60000/1000)).padStart(2,"0"),V=document.getElementById("next-update");if(V)V.textContent=`${v[K].nextUpdate} ${B}:${J}`}function r(q){let z=Math.floor(q.getTime()/6000);if(K==="zh")return["gregory","japanese","chinese"][z%3];return["gregory","japanese"][z%2]}function s(){let q=new Date,z=q.getHours(),B=z.toString().padStart(2,"0"),J=q.getMinutes().toString().padStart(2,"0"),V=q.getSeconds().toString().padStart(2,"0");document.getElementById("clock").textContent=`${B}:${J}:${V}`;let Q=(z+11)%12+1,Y=z<12,j=K==="en"?`${Y?"AM":"PM"} ${Q}:00`:K==="zh"?`${Y?"上午":"下午"}${Q}点`:K==="ko"?`${Y?"오전":"오후"} ${Q}시`:`${Y?"午前":"午後"}${Q}時`,$=document.getElementById("clock12-str");if($)$.textContent=j;let M=["日","月","火","水","木","金","土"],X=q.getFullYear(),D=(q.getMonth()+1).toString().padStart(2,"0"),a=q.getDate().toString().padStart(2,"0"),w=M[q.getDay()],S=document.getElementById("weekday-str");if(S){let u=K==="en"?["SUN","MON","TUE","WED","THU","FRI","SAT"][q.getDay()]:K==="zh"?["周日","周一","周二","周三","周四","周五","周六"][q.getDay()]:K==="ko"?["일","월","화","수","목","금","토"][q.getDay()]:`${w}曜`;S.textContent=u}let N=r(q),O=document.getElementById("date-str");if(O)O.textContent=o(q,N),O.classList.toggle("is-chinese-cal",N==="chinese");i(q)}var C;function n(){document.body.classList.remove("cursor-hidden"),clearTimeout(C),C=setTimeout(()=>{document.body.classList.add("cursor-hidden")},3000)}["mousemove","mousedown","wheel","touchstart","keydown"].forEach((q)=>{window.addEventListener(q,n,{passive:!0})});var A=["ja","en","zh","ko"],W=0;function c(q){if(q===K)return;K=q,p(),H.forEach((B)=>{if(F[B.id])R(B,F[B.id])}),b(Z),k(),x();let z=new Date;document.getElementById("last-updated").textContent=`${v[K].updated}: ${z.getHours().toString().padStart(2,"0")}:${z.getMinutes().toString().padStart(2,"0")}`}function e(){W=(W+1)%A.length,c(A[W])}p();g();s();setInterval(s,1000);L();k();x();document.body.classList.add("cursor-hidden");setInterval(L,f);setInterval(k,600000);setInterval(x,60000);var I=0;setInterval(()=>{if(b(Z+1),I++,I%2===0)e()},12000);
